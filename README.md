# AWS Elastic Beanstalk Wordpress Deployment

## Setting your Development environment

### Dependencies managment with composer

You first need to install Wordpress and its plugins using composer like:

```
composer.phar install
```

Most of the WP plugins can be found on [wordpress packagist](https://wpackagist.org/), add them to your composer.json like:

```
    "require": {
        "php": ">=7.0",
        "johnpbloch/wordpress": ">=4.7.2",
        "composer/installers": "~1.0",
        "wpackagist-plugin/contact-form-7": "4.6.1",
        "wpackagist-plugin/business-profile": "1.1.1",
        "robmorgan/phinx": "~0.6.0",
        "wp-cli/wp-cli": "^1.0",
        "phing/phing": "~2.14"
    },
```

### Set the Phing environment variables

To set your local development environment copy the build.local.properties.sample to build.local.properties.

```
cp build.local.properties.sample build.local.properties
``` 

### Configure Wordpress

```
cp wp/wp-config-sample.php wp/wp-config.php 
```
Set the envirnoment variables as:

```
/** The name of the database for WordPress */
define('DB_NAME',     $_SERVER["MYSQL_ADDON_DB"]);

/** MySQL database username */
define('DB_USER',     $_SERVER["MYSQL_ADDON_USER"]);

/** MySQL database password */
define('DB_PASSWORD', $_SERVER["MYSQL_ADDON_PASSWORD"]);

/** MySQL hostname */
define('DB_HOST',     $_SERVER["MYSQL_ADDON_HOST"]);

/** Database Charset to use in creating database tables. */
define('DB_CHARSET', 'utf8');

/** The Database Collate type. Don't change this if in doubt. */
define('DB_COLLATE', '');
```

And Add:

```
define('AUTH_KEY',         $_SERVER["AUTH_KEY"]);
define('SECURE_AUTH_KEY',  $_SERVER["SECURE_AUTH_KEY"]);
define('LOGGED_IN_KEY',    $_SERVER["LOGGED_IN_KEY"]);
define('NONCE_KEY',        $_SERVER["NONCE_KEY"]);
define('AUTH_SALT',        $_SERVER["AUTH_SALT"]);
define('SECURE_AUTH_SALT', $_SERVER["SECURE_AUTH_SALT"]);
define('LOGGED_IN_SALT',   $_SERVER["LOGGED_IN_SALT"]);
define('NONCE_SALT',       $_SERVER["NONCE_SALT"]);
```

Once finished, copy the wp/wp-config.php in the wp-root/ folder.
 
#### Initialize your Database

```
./vendor/bin/phing reset-db
```

#### Install WordPress

Open in your browser http://192.168.99.100/wp-admin/install.php to install your WordPress.
Complete the information and click **Install WordPress**

Your WordPress is ready to customized.

#### Plugin Install

We are going to add the updraftplus plugin to backup our install on S3, for this we add the "wpackagist-plugin/updraftplus" dependency in our composer.json file.

```
    "require": {
        "php": ">=7.0",
        "johnpbloch/wordpress": ">=4.7.2",
        "composer/installers": "~1.0",
        "wpackagist-plugin/contact-form-7": "4.6.1",
        "wpackagist-plugin/business-profile": "1.1.1",
        "wpackagist-plugin/updraftplus": "1.12.32",
        "robmorgan/phinx": "~0.6.0",
        "wp-cli/wp-cli": "^1.0",
        "phing/phing": "~2.14"
    },
```



















### Set the Elastic Beanstalk environment variables

Elastic Beanstalk use exported environment variables, we will have to set these in Elastic Beanstalk Configuration Software Configuration Environment variables.
The S3_BACKUP_URL and S3_MEDIA_URL are buckets backup files generated by the wordpress UpdraftPlus - Backup/Restore, use them to restore your environment.

To avoid notice configure the environment variables on your development environment.

```
export MYSQL_ADDON_HOST=192.168.99.100
export MYSQL_ADDON_DB=wordpress
export MYSQL_ADDON_PASSWORD=password
export MYSQL_ADDON_USER=root
export S3_BACKUP_URL=s3://backup-bucket/db-backup-updraftplus.zip
export S3_MEDIA_URL=s3://backup-bucket/media-backup-updraftplus.zip
export ENVIRONMENT=develop
export AUTH_KEY=""
export SECURE_AUTH_KEY=""
export LOGGED_IN_KEY=""
export NONCE_KEY=""
export AUTH_SALT=""
export SECURE_AUTH_SALT=""
export LOGGED_IN_SALT=""
export NONCE_SALT=""
export DBI_AWS_ACCESS_KEY_ID=""
export DBI_AWS_SECRET_ACCESS_KEY=""
```

### Start docker-compose

```
docker-compose up
```

### Setup your wordpress

```
./vendor/bin/phing setup-dev
```

Open you browser to http://192.168.99.100

Run phing without any argugments to get the list of all the targets. 

### Running behat test

```
./vendor/bin/behat -c tests/behat.local.yml
```
